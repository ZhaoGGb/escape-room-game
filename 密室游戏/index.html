<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3Då¯†å®¤é€ƒè„± - æ²‰æµ¸å¼ä½“éªŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        canvas {
            display: block;
        }

        .ui-overlay {
            position: fixed;
            z-index: 100;
            pointer-events: none;
        }

        .ui-overlay * {
            pointer-events: auto;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-controls {
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%);
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            color: #00ff88;
            letter-spacing: 2px;
        }

        .view-controls {
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 136, 0.5);
            background: rgba(0, 0, 0, 0.6);
            color: #00ff88;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .ctrl-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        /* åº•éƒ¨ä¿¡æ¯æ  */
        .bottom-info {
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .hint-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            max-width: 300px;
            line-height: 1.5;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ç‰©å“ä¿¡æ¯å¼¹çª— */
        .item-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(10, 15, 20, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 30px;
            min-width: 320px;
            max-width: 90vw;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(0, 255, 136, 0.1);
        }

        .item-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .modal-title {
            font-size: 1.3rem;
            color: #00ff88;
            font-weight: bold;
        }

        .close-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 100, 100, 0.3);
            transform: rotate(90deg);
        }

        .modal-content {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .modal-content p {
            margin-bottom: 15px;
        }

        .modal-hint {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
            padding: 12px 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
        }

        .password-display {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            font-size: 2.5rem;
            text-align: center;
            letter-spacing: 15px;
            color: #00ff88;
            margin: 20px 0;
            font-family: monospace;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 250px;
            margin: 0 auto;
        }

        .key-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px;
            font-size: 1.3rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .key-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            transform: scale(1.05);
        }

        .key-btn:active {
            transform: scale(0.95);
        }

        .key-clear {
            background: rgba(255, 100, 100, 0.2);
            border-color: rgba(255, 100, 100, 0.5);
        }

        .key-clear:hover {
            background: rgba(255, 100, 100, 0.4);
            border-color: #ff6464;
        }

        .key-enter {
            background: rgba(0, 255, 136, 0.2);
            border-color: rgba(0, 255, 136, 0.5);
        }

        .key-enter:hover {
            background: rgba(0, 255, 136, 0.4);
            border-color: #00ff88;
        }

        /* åŠ è½½ç•Œé¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-title {
            font-size: 2rem;
            color: #00ff88;
            margin-bottom: 40px;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        /* æ”¶è—å“é¢æ¿ */
        .inventory-panel {
            position: fixed;
            right: -400px;
            top: 0;
            bottom: 0;
            width: 350px;
            background: rgba(10, 15, 20, 0.95);
            border-left: 1px solid rgba(0, 255, 136, 0.2);
            z-index: 150;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
        }

        .inventory-panel.active {
            right: 0;
        }

        .inventory-header {
            padding: 25px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-title {
            font-size: 1.2rem;
            color: #00ff88;
            font-weight: bold;
        }

        .inventory-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .inventory-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 40px 20px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .inventory-item:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            transform: translateX(-5px);
        }

        .inventory-item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .inventory-item-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .inventory-item-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* æ“ä½œæç¤º */
        .action-hint {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 150;
        }

        .action-hint.visible {
            opacity: 1;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-title {
                font-size: 1.1rem;
            }

            .ctrl-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .bottom-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .hint-text {
                max-width: 100%;
            }

            .stats {
                width: 100%;
                justify-content: space-around;
            }

            .item-modal {
                min-width: 280px;
                padding: 20px;
            }

            .inventory-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* æˆåŠŸæç¤º */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .success-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .success-icon {
            font-size: 5rem;
            margin-bottom: 30px;
            animation: bounce 0.6s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .success-title {
            font-size: 2.5rem;
            color: #00ff88;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .success-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin-bottom: 40px;
        }

        .restart-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border: none;
            color: #000;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        }

        /* æ§åˆ¶è¯´æ˜ */
        .controls-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            z-index: 100;
        }

        .controls-help p {
            margin: 5px 0;
        }

        .controls-help span {
            color: #00ff88;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-title">ğŸ” å¯†å®¤é€ƒè„±</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="loading-text" id="loadingText">æ­£åœ¨åˆå§‹åŒ–åœºæ™¯...</div>
    </div>

    <!-- 3Dåœºæ™¯å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <div class="ui-overlay top-controls">
        <div class="game-title">ğŸ” 3Då¯†å®¤é€ƒè„±</div>
        <div class="view-controls">
            <button class="ctrl-btn" id="resetViewBtn" title="é‡ç½®è§†è§’">ğŸ”„</button>
            <button class="ctrl-btn" id="inventoryBtn" title="ç‰©å“æ ">ğŸ’</button>
            <button class="ctrl-btn" id="helpBtn" title="å¸®åŠ©">â“</button>
        </div>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯æ  -->
    <div class="ui-overlay bottom-info">
        <div class="hint-text">
            ğŸ–±ï¸ å·¦é”®æ‹–åŠ¨æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | å³é”®å¹³ç§» | ç‚¹å‡»ç‰©å“æŸ¥çœ‹è¯¦æƒ…
        </div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="fpsValue">60</div>
                <div class="stat-label">FPS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="objectsCount">0</div>
                <div class="stat-label">ç‰©ä½“æ•°</div>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶è¯´æ˜ -->
    <div class="controls-help">
        <p><span>ğŸ–±ï¸ æ‹–åŠ¨</span> æ—‹è½¬è§†è§’</p>
        <p><span>ğŸ” æ»šè½®</span> ç¼©æ”¾æŸ¥çœ‹</p>
        <p><span>ğŸ‘† ç‚¹å‡»</span> ç‰©å“äº¤äº’</p>
    </div>

    <!-- ç‰©å“è¯¦æƒ…å¼¹çª— -->
    <div class="item-modal" id="itemModal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">ç‰©å“åç§°</div>
            <button class="close-btn" id="closeModal">Ã—</button>
        </div>
        <div class="modal-content" id="modalContent">
            <!-- ç‰©å“è¯¦æƒ…å†…å®¹ -->
        </div>
    </div>

    <!-- å¯†ç è¾“å…¥æ¨¡æ€æ¡† -->
    <div class="item-modal" id="passwordModal">
        <div class="modal-header">
            <div class="modal-title" id="passwordTitle">ğŸ”’ è¾“å…¥å¯†ç </div>
            <button class="close-btn" id="closePassword">Ã—</button>
        </div>
        <div class="modal-content">
            <p id="passwordHint">è¯·è¾“å…¥4ä½å¯†ç </p>
            <div class="password-display" id="passwordDisplay">----</div>
            <div class="keypad">
                <button class="key-btn" data-digit="1">1</button>
                <button class="key-btn" data-digit="2">2</button>
                <button class="key-btn" data-digit="3">3</button>
                <button class="key-btn" data-digit="4">4</button>
                <button class="key-btn" data-digit="5">5</button>
                <button class="key-btn" data-digit="6">6</button>
                <button class="key-btn" data-digit="7">7</button>
                <button class="key-btn" data-digit="8">8</button>
                <button class="key-btn" data-digit="9">9</button>
                <button class="key-btn key-clear" data-digit="clear">C</button>
                <button class="key-btn" data-digit="0">0</button>
                <button class="key-btn key-enter" data-digit="enter">âœ“</button>
            </div>
        </div>
    </div>

    <!-- ç‰©å“æ é¢æ¿ -->
    <div class="inventory-panel" id="inventoryPanel">
        <div class="inventory-header">
            <div class="inventory-title">ğŸ’ æ”¶é›†çš„ç‰©å“</div>
            <button class="close-btn" id="closeInventory">Ã—</button>
        </div>
        <div class="inventory-content" id="inventoryContent">
            <div class="inventory-empty">
                è¿˜æ²¡æœ‰æ”¶é›†ä»»ä½•ç‰©å“<br>
                æ¢ç´¢æˆ¿é—´æ¥å‘ç°çº¿ç´¢å§ï¼
            </div>
        </div>
    </div>

    <!-- æ“ä½œæç¤º -->
    <div class="action-hint" id="actionHint">ç‚¹å‡»ç‰©å“è¿›è¡Œäº¤äº’</div>

    <!-- æˆåŠŸæç¤º -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-icon">ğŸ‰</div>
        <div class="success-title">æˆåŠŸé€ƒè„±ï¼</div>
        <div class="success-text">ä½ å‘ç°äº†æ‰€æœ‰çº¿ç´¢å¹¶æˆåŠŸæ‰“å¼€äº†å¯†å®¤çš„é—¨</div>
        <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ==================== å…¨å±€å˜é‡ ====================
        let scene, camera, renderer, controls;
        let raycaster, mouse;
        let clock;
        let interactiveObjects = [];
        let collectedItems = [];
        let isGameComplete = false;

        // éšæœºå¯†ç 
        let drawerPassword = '';
        let safePassword = '';
        let doorPassword = '';

        function generateRandomPassword() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function initRandomPasswords() {
            drawerPassword = generateRandomPassword();
            safePassword = generateRandomPassword();
            doorPassword = generateRandomPassword();
            console.log(`å¯†ç å·²ç”Ÿæˆ - æŠ½å±‰: ${drawerPassword}, ä¿é™©ç®±: ${safePassword}, é—¨: ${doorPassword}`);
        }

        // ç‰©å“æ•°æ®
        const itemData = {
            'door': {
                name: 'ğŸšª å§å®¤é—¨',
                description: 'ä¸€æ‰‡åšé‡çš„æœ¨é—¨ï¼Œä¸Šé¢æœ‰å¯†ç é”å’Œé’¥åŒ™å­”ã€‚éœ€è¦å¯†ç å’Œé’¥åŒ™æ‰èƒ½æ‰“å¼€ã€‚',
                hint: 'æ‰¾åˆ°å¯†ç å’Œé’¥åŒ™å°±èƒ½æ‰“å¼€è¿™æ‰‡é—¨...',
                canCollect: false
            },
            'window': {
                name: 'ğŸªŸ çª—æˆ·',
                description: 'ä¸€æ‰‡è¢«æœ¨æ¿å°æ­»çš„çª—æˆ·ï¼Œå¤–é¢æ˜¯æ¼†é»‘çš„å¤œæ™šã€‚æœˆå…‰é€è¿‡ç¼éš™ç…§å°„è¿›æ¥ã€‚',
                hint: 'çª—æˆ·è¢«å°æ­»äº†ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé€ƒè„±çš„çº¿ç´¢...',
                canCollect: false
            },
            'trash': {
                name: 'ğŸ—‘ï¸ åƒåœ¾æ¡¶',
                description: 'ä¸€ä¸ªæ™®é€šçš„é‡‘å±åƒåœ¾æ¡¶ï¼Œæ¡¶å†…æœ‰æ‰çš±çš„çº¸å›¢ã€‚',
                hint: 'ä¹Ÿè®¸çº¸å›¢ä¸Šæœ‰ä»€ä¹ˆä¿¡æ¯ï¼Ÿç‚¹å‡»åƒåœ¾æ¡¶æŸ¥çœ‹ã€‚',
                canCollect: true,
                collected: false
            },
            'paper': {
                name: 'ğŸ“„ çš±çº¸å›¢',
                description: `ä»åƒåœ¾æ¡¶é‡Œæ‰¾åˆ°çš„çº¸å›¢ï¼Œä¸Šé¢æ½¦è‰åœ°å†™ç€æ•°å­—ï¼š${drawerPassword.slice(0,1)}-${drawerPassword.slice(1,2)}-${drawerPassword.slice(2,3)}-${drawerPassword.slice(3,4)}`,
                hint: 'è®°ä½è¿™ä¸ªæ•°å­—ï¼ä¹Ÿè®¸è¿™æ˜¯æŸä¸ªé”çš„å¯†ç ã€‚',
                canCollect: true,
                collected: false
            },
            'bed': {
                name: 'ğŸ›ï¸ åºŠ',
                description: 'ä¸€å¼ å‡Œä¹±çš„åºŠï¼Œæ•å¤´ä¸‹é¢å‹ç€ä¸€æœ¬æ—¥è®°ã€‚',
                hint: 'æŸ¥çœ‹æ—¥è®°ä¹Ÿè®¸èƒ½è·å¾—é‡è¦ä¿¡æ¯ã€‚',
                canCollect: false
            },
            'diary': {
                name: 'ğŸ“” æ—¥è®°æœ¬',
                description: `æ—¥è®°çš„æœ€åä¸€é¡µå†™ç€ï¼š"è®°ä½ï¼Œå¯†ç é”çš„é¡ºåºæ˜¯åçš„..." å¯†ç ï¼š${drawerPassword.slice(0,1)}-${drawerPassword.slice(1,2)}-${drawerPassword.slice(2,3)}-${drawerPassword.slice(3,4)}`,
                hint: `å¯†ç é¡ºåºæ˜¯åçš„ï¼${drawerPassword.slice(0,1)}-${drawerPassword.slice(1,2)}-${drawerPassword.slice(2,3)}-${drawerPassword.slice(3,4)}åè¿‡æ¥å°±æ˜¯${doorPassword.slice(0,1)}-${doorPassword.slice(1,2)}-${doorPassword.slice(2,3)}-${doorPassword.slice(3,4)}`,
                canCollect: true,
                collected: false
            },
            'desk': {
                name: 'ğŸª‘ ä¹¦æ¡Œ',
                description: 'ä¸€å¼ è€æ—§çš„ä¹¦æ¡Œï¼ŒæŠ½å±‰ä¼¼ä¹è¢«é”ä½äº†ã€‚',
                hint: 'æŠ½å±‰éœ€è¦é’¥åŒ™æ‰èƒ½æ‰“å¼€ã€‚',
                canCollect: false
            },
            'drawer': {
                name: 'ğŸ—ï¸ æŠ½å±‰é”',
                description: 'æŠ½å±‰ä¸Šæœ‰ä¸€ä¸ªå°é”å­”ï¼Œéœ€è¦æ‰¾åˆ°é’¥åŒ™ã€‚',
                hint: 'é’¥åŒ™å¯èƒ½è—åœ¨æˆ¿é—´çš„æŸä¸ªåœ°æ–¹ã€‚',
                canCollect: false,
                opened: false
            },
            'key': {
                name: 'ğŸ”‘ å°é’¥åŒ™',
                description: 'åœ¨èŠ±ç›†åº•éƒ¨å‘ç°çš„é“¶è‰²å°é’¥åŒ™ï¼Œçœ‹èµ·æ¥å¯ä»¥æ‰“å¼€ä»€ä¹ˆä¸œè¥¿ã€‚',
                hint: 'è¿™æŠŠé’¥åŒ™ä¹Ÿè®¸èƒ½æ‰“å¼€æŠ½å±‰ï¼',
                canCollect: true,
                collected: false
            },
            'painting': {
                name: 'ğŸ–¼ï¸ æ²¹ç”»',
                description: 'ä¸€å¹…é£æ™¯æ²¹ç”»ï¼Œç”»çš„æ˜¯æ—¥è½æ—¶çš„å±±è„‰ã€‚ç”»æ¡†ä¼¼ä¹æœ‰äº›æ¾åŠ¨ã€‚',
                hint: 'ç”»æ¡†åé¢ä¹Ÿè®¸è—ç€ä»€ä¹ˆç§˜å¯†ï¼Ÿ',
                canCollect: false
            },
            'safe': {
                name: 'ğŸ”’ ä¿é™©ç®±',
                description: 'å¢™ä¸Šçš„ä¿é™©ç®±ï¼Œéœ€è¦è¾“å…¥4ä½å¯†ç æ‰èƒ½æ‰“å¼€ã€‚',
                hint: 'è¾“å…¥æ­£ç¡®çš„å¯†ç è¯•è¯•çœ‹ï¼',
                canCollect: false,
                opened: false
            },
            'plant': {
                name: 'ğŸª´ ç›†æ ½',
                description: 'ä¸€ç›†æ¯èçš„ç»¿æ¤ï¼ŒèŠ±ç›†é‡Œçš„åœŸçœ‹èµ·æ¥è¢«äººç¿»åŠ¨è¿‡ã€‚',
                hint: 'æ£€æŸ¥èŠ±ç›†é‡Œçš„åœŸå£¤ã€‚',
                canCollect: true,
                collected: false
            },
            'safe_content': {
                name: 'ğŸ”‘ é—¨é’¥åŒ™',
                description: 'ä¿é™©ç®±é‡Œçš„é‡‘è‰²é’¥åŒ™ï¼è¿™ä¸€å®šæ˜¯æ‰“å¼€æˆ¿é—¨çš„é’¥åŒ™ï¼',
                hint: 'å¸¦ç€è¿™æŠŠé’¥åŒ™å»å¼€é—¨å§ï¼',
                canCollect: true,
                collected: false
            },
            'clock': {
                name: 'ğŸ• æŒ‚é’Ÿ',
                description: 'ä¸€ä¸ªåœæ­¢çš„æŒ‚é’Ÿï¼ŒæŒ‡é’ˆåœåœ¨7ç‚¹20åˆ†ã€‚',
                hint: '7:20...è¿™ä¸ªæ—¶é—´æœ‰ä»€ä¹ˆç‰¹æ®Šå«ä¹‰å—ï¼Ÿ',
                canCollect: false
            },
            'lamp': {
                name: 'ğŸ’¡ å°ç¯',
                description: 'ä¸€ç›è€å¼å°ç¯ï¼Œç¯ç½©ä¸Šç§¯æ»¡äº†ç°å°˜ã€‚',
                hint: 'ç°å°˜é‡Œä¹Ÿè®¸èƒ½æå–åˆ°æŒ‡çº¹...',
                canCollect: false
            }
        };

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            // åˆå§‹åŒ–éšæœºå¯†ç 
            initRandomPasswords();
            itemData['safe'].hint = `è¾“å…¥å¯†ç  ${safePassword.slice(0,1)}-${safePassword.slice(1,2)}-${safePassword.slice(2,3)}-${safePassword.slice(3,4)} è¯•è¯•çœ‹ï¼`;

            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.Fog(0x0a0a0a, 5, 25);

            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(4, 3, 5);

            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // åˆ›å»ºæ§åˆ¶å™¨
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 15;
            controls.maxPolarAngle = Math.PI * 0.85;
            controls.target.set(0, 1.5, 0);

            // åˆå§‹åŒ–å°„çº¿æ£€æµ‹
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            clock = new THREE.Clock();

            // æ·»åŠ åœºæ™¯å†…å®¹
            addLighting();
            createRoom();
            createFurniture();
            addInteractiveObjects();

            // æ›´æ–°ç‰©ä½“æ•°é‡
            document.getElementById('objectsCount').textContent = interactiveObjects.length;

            // äº‹ä»¶ç›‘å¬
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('click', onMouseClick);
            renderer.domElement.addEventListener('mousemove', onMouseMove);

            // UIäº‹ä»¶
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeInventory').addEventListener('click', toggleInventory);
            document.getElementById('closePassword').addEventListener('click', closePasswordModal);
            document.getElementById('inventoryBtn').addEventListener('click', toggleInventory);
            document.getElementById('resetViewBtn').addEventListener('click', resetView);
            document.getElementById('restartBtn').addEventListener('click', restartGame);

            // å¯†ç é”®ç›˜äº‹ä»¶
            document.querySelectorAll('.key-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    handlePasswordDigit(btn.dataset.digit);
                });
            });

            // æ¨¡æ‹ŸåŠ è½½è¿›åº¦
            simulateLoading();

            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
        }

        // ==================== åŠ è½½è¿›åº¦æ¨¡æ‹Ÿ ====================
        function simulateLoading() {
            const loadingBar = document.getElementById('loadingBar');
            const loadingText = document.getElementById('loadingText');
            const loadingScreen = document.getElementById('loadingScreen');
            const stages = [
                { progress: 20, text: 'æ„å»ºå¯†å®¤ç»“æ„...' },
                { progress: 40, text: 'æ·»åŠ å®¶å…·æ¨¡å‹...' },
                { progress: 60, text: 'è®¾ç½®å…‰ç…§æ•ˆæœ...' },
                { progress: 80, text: 'é…ç½®äº¤äº’ç³»ç»Ÿ...' },
                { progress: 100, text: 'å‡†å¤‡å®Œæˆï¼' }
            ];

            let currentStage = 0;
            const interval = setInterval(() => {
                if (currentStage < stages.length) {
                    loadingBar.style.width = stages[currentStage].progress + '%';
                    loadingText.textContent = stages[currentStage].text;
                    currentStage++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                    }, 500);
                }
            }, 400);
        }

        // ==================== å…‰ç…§ç³»ç»Ÿ ====================
        function addLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404050, 0.4);
            scene.add(ambientLight);

            // ä¸»å…‰æºï¼ˆæ¨¡æ‹ŸåŠç¯ï¼‰
            const mainLight = new THREE.PointLight(0xffeedd, 1.5, 20);
            mainLight.position.set(0, 3.5, 0);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            mainLight.shadow.camera.near = 0.5;
            mainLight.shadow.camera.far = 15;
            scene.add(mainLight);

            // è¾…åŠ©å…‰æºï¼ˆå°ç¯ï¼‰
            const deskLight = new THREE.PointLight(0xffaa66, 0.8, 8);
            deskLight.position.set(-2, 1.8, -1.5);
            scene.add(deskLight);

            // çª—æˆ·æœˆå…‰æ•ˆæœ
            const moonLight = new THREE.DirectionalLight(0x6688ff, 0.3);
            moonLight.position.set(5, 3, 0);
            scene.add(moonLight);

            // é—¨ç¼é€å…‰
            const doorLight = new THREE.PointLight(0xffeedd, 0.5, 3);
            doorLight.position.set(2.55, 1.5, 0);
            scene.add(doorLight);
        }

        // ==================== åˆ›å»ºæˆ¿é—´ ====================
        function createRoom() {
            // åœ°æ¿
            const floorGeometry = new THREE.PlaneGeometry(6, 6);
            const floorMaterial = new THREE.MeshStandardMaterial({
                color: 0x3a3a3a,
                roughness: 0.8,
                metalness: 0.2
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // æ·»åŠ åœ°æ¿çº¹ç†çº¿æ¡
            const lineGeometry = new THREE.EdgesGeometry(new THREE.PlaneGeometry(6, 6));
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x555555 });
            const floorLines = new THREE.LineSegments(lineGeometry, lineMaterial);
            floorLines.rotation.x = -Math.PI / 2;
            floorLines.position.y = 0.001;
            scene.add(floorLines);

            // å¤©èŠ±æ¿
            const ceilingGeometry = new THREE.PlaneGeometry(6, 6);
            const ceilingMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a2a,
                roughness: 0.9,
                metalness: 0.1
            });
            const ceiling = new THREE.Mesh(ceilingGeometry, ceilingMaterial);
            ceiling.rotation.x = Math.PI / 2;
            ceiling.position.y = 4;
            scene.add(ceiling);

            // å¢™å£æè´¨
            const wallMaterial = new THREE.MeshStandardMaterial({
                color: 0xd4c4b0,
                roughness: 0.85,
                metalness: 0.1
            });

            // åå¢™
            const backWall = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), wallMaterial);
            backWall.position.set(0, 2, -3);
            backWall.receiveShadow = true;
            scene.add(backWall);

            // é—¨æ´ï¼ˆåå¢™ä¸­å¤®ï¼‰
            const doorFrameMaterial = new THREE.MeshStandardMaterial({
                color: 0x4a3728,
                roughness: 0.7,
                metalness: 0.2
            });

            const doorFrame = new THREE.Mesh(
                new THREE.BoxGeometry(1.3, 2.5, 0.15),
                doorFrameMaterial
            );
            doorFrame.position.set(0, 1.25, -2.95);
            doorFrame.castShadow = true;
            scene.add(doorFrame);

            // é—¨æ¿
            const door = new THREE.Mesh(
                new THREE.BoxGeometry(1.1, 2.4, 0.08),
                new THREE.MeshStandardMaterial({ color: 0x5c4033, roughness: 0.6 })
            );
            door.position.set(0, 1.2, -2.9);
            door.castShadow = true;
            door.name = 'door';
            scene.add(door);
            interactiveObjects.push(door);

            // é—¨æŠŠæ‰‹
            const doorHandle = new THREE.Mesh(
                new THREE.SphereGeometry(0.05),
                new THREE.MeshStandardMaterial({ color: 0xc4a747, metalness: 0.8, roughness: 0.3 })
            );
            doorHandle.position.set(0.45, 1.2, -2.85);
            scene.add(doorHandle);

            // é—¨é”æç¤º
            const doorLock = new THREE.Mesh(
                new THREE.CylinderGeometry(0.03, 0.03, 0.02),
                new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.8 })
            );
            doorLock.rotation.x = Math.PI / 2;
            doorLock.position.set(0, 1.5, -2.86);
            scene.add(doorLock);

            // å‰å¢™
            const frontWall = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), wallMaterial);
            frontWall.position.set(0, 2, 3);
            frontWall.rotation.y = Math.PI;
            scene.add(frontWall);

            // å·¦å¢™
            const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), wallMaterial);
            leftWall.position.set(-3, 2, 0);
            leftWall.rotation.y = Math.PI / 2;
            leftWall.receiveShadow = true;
            scene.add(leftWall);

            // å³å¢™
            const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), wallMaterial);
            rightWall.position.set(3, 2, 0);
            rightWall.rotation.y = -Math.PI / 2;
            scene.add(rightWall);
        }

        // ==================== åˆ›å»ºå®¶å…· ====================
        function createFurniture() {
            // åºŠ
            createBed();

            // ä¹¦æ¡Œ
            createDesk();

            // ä¿é™©ç®±
            createSafe();

            // è¡£æŸœ
            createWardrobe();

            // ç›†æ ½
            createPlant();

            // æŒ‚é’Ÿ
            createClock();

            // åƒåœ¾æ¡¶
            createTrash();

            // æ²¹ç”»
            createPainting();
        }

        function createBed() {
            const bedGroup = new THREE.Group();

            // åºŠæ¶
            const bedFrame = new THREE.Mesh(
                new THREE.BoxGeometry(2, 0.5, 2.5),
                new THREE.MeshStandardMaterial({ color: 0x4a3728, roughness: 0.7 })
            );
            bedFrame.position.y = 0.25;
            bedFrame.castShadow = true;
            bedGroup.add(bedFrame);

            // åºŠå«
            const mattress = new THREE.Mesh(
                new THREE.BoxGeometry(1.9, 0.3, 2.4),
                new THREE.MeshStandardMaterial({ color: 0xf5f5dc, roughness: 0.9 })
            );
            mattress.position.y = 0.65;
            mattress.castShadow = true;
            bedGroup.add(mattress);

            // æ•å¤´
            const pillow = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.15, 0.35),
                new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 })
            );
            pillow.position.set(0.5, 0.95, 1);
            pillow.name = 'bed';
            bedGroup.add(pillow);
            interactiveObjects.push(pillow);

            // è¢«å­
            const blanket = new THREE.Mesh(
                new THREE.BoxGeometry(1.8, 0.2, 1.5),
                new THREE.MeshStandardMaterial({ color: 0x8b4513, roughness: 0.8 })
            );
            blanket.position.set(-0.1, 0.9, 0);
            blanket.castShadow = true;
            bedGroup.add(blanket);

            bedGroup.position.set(2, 0, -2);
            scene.add(bedGroup);
        }

        function createDesk() {
            const deskGroup = new THREE.Group();

            // æ¡Œé¢
            const desktop = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 0.08, 0.8),
                new THREE.MeshStandardMaterial({ color: 0x5c4033, roughness: 0.6 })
            );
            desktop.position.y = 0.8;
            desktop.castShadow = true;
            deskGroup.add(desktop);

            // æ¡Œè…¿
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x4a3728 });
            const legGeometry = new THREE.BoxGeometry(0.08, 0.8, 0.08);
            
            const leg1 = new THREE.Mesh(legGeometry, legMaterial);
            leg1.position.set(-0.65, 0.4, 0.3);
            deskGroup.add(leg1);

            const leg2 = new THREE.Mesh(legGeometry, legMaterial);
            leg2.position.set(0.65, 0.4, 0.3);
            deskGroup.add(leg2);

            const leg3 = new THREE.Mesh(legGeometry, legMaterial);
            leg3.position.set(-0.65, 0.4, -0.3);
            deskGroup.add(leg3);

            const leg4 = new THREE.Mesh(legGeometry, legMaterial);
            leg4.position.set(0.65, 0.4, -0.3);
            deskGroup.add(leg4);

            // æŠ½å±‰
            const drawer = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.4, 0.5),
                new THREE.MeshStandardMaterial({ color: 0x5c4033, roughness: 0.6 })
            );
            drawer.position.set(-0.4, 0.38, 0);
            drawer.name = 'drawer';
            deskGroup.add(drawer);
            interactiveObjects.push(drawer);

            // æŠ½å±‰æŠŠæ‰‹
            const drawerHandle = new THREE.Mesh(
                new THREE.CylinderGeometry(0.03, 0.03, 0.1),
                new THREE.MeshStandardMaterial({ color: 0xc4a747, metalness: 0.8 })
            );
            drawerHandle.rotation.z = Math.PI / 2;
            drawerHandle.position.set(-0.4, 0.38, 0.28);
            deskGroup.add(drawerHandle);

            // å°ç¯
            const lampGroup = new THREE.Group();
            const lampBase = new THREE.Mesh(
                new THREE.CylinderGeometry(0.1, 0.12, 0.05),
                new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.8 })
            );
            lampBase.position.y = 0.85;
            lampGroup.add(lampBase);

            const lampPole = new THREE.Mesh(
                new THREE.CylinderGeometry(0.02, 0.02, 0.4),
                new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.6 })
            );
            lampPole.position.y = 1.1;
            lampGroup.add(lampPole);

            const lampShade = new THREE.Mesh(
                new THREE.ConeGeometry(0.15, 0.2, 8, 1, true),
                new THREE.MeshStandardMaterial({ 
                    color: 0xf5deb3, 
                    roughness: 0.8,
                    side: THREE.DoubleSide
                })
            );
            lampShade.position.y = 1.35;
            lampGroup.add(lampShade);
            lampShade.name = 'lamp';
            interactiveObjects.push(lampShade);

            // ç¯æ³¡å…‰æ™•
            const bulbGlow = new THREE.PointLight(0xffaa66, 0.5, 2);
            bulbGlow.position.y = 1.3;
            lampGroup.add(bulbGlow);

            lampGroup.position.set(0.4, 0, 0);
            deskGroup.add(lampGroup);

            // æ—¥è®°æœ¬
            const diary = new THREE.Mesh(
                new THREE.BoxGeometry(0.2, 0.03, 0.25),
                new THREE.MeshStandardMaterial({ color: 0x8b0000, roughness: 0.7 })
            );
            diary.position.set(-0.3, 0.86, -0.2);
            diary.rotation.y = 0.2;
            diary.name = 'diary';
            deskGroup.add(diary);
            interactiveObjects.push(diary);

            deskGroup.position.set(-2, 0, 2);
            scene.add(deskGroup);
        }

        function createSafe() {
            const safeGroup = new THREE.Group();

            // ä¿é™©ç®±ä¸»ä½“
            const safeBody = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.5, 0.3),
                new THREE.MeshStandardMaterial({ 
                    color: 0x2a2a2a, 
                    metalness: 0.9, 
                    roughness: 0.3 
                })
            );
            safeBody.castShadow = true;
            safeGroup.add(safeBody);

            // å¯†ç é¢æ¿
            const keypad = new THREE.Mesh(
                new THREE.PlaneGeometry(0.3, 0.25),
                new THREE.MeshStandardMaterial({ color: 0x1a1a1a })
            );
            keypad.position.z = 0.16;
            keypad.name = 'safe';
            safeGroup.add(keypad);
            interactiveObjects.push(keypad);

            // å¯†ç æ•°å­—
            for (let i = 0; i < 4; i++) {
                const digit = new THREE.Mesh(
                    new THREE.PlaneGeometry(0.05, 0.08),
                    new THREE.MeshBasicMaterial({ color: 0x00ff00 })
                );
                digit.position.set(-0.1 + i * 0.07, 0.05, 0.17);
                safeGroup.add(digit);
            }

            // æ—‹è½¬æŠŠæ‰‹
            const handle = new THREE.Mesh(
                new THREE.TorusGeometry(0.08, 0.02, 8, 16),
                new THREE.MeshStandardMaterial({ color: 0xc4a747, metalness: 0.8 })
            );
            handle.position.set(0.15, 0, 0.15);
            handle.rotation.y = Math.PI / 2;
            safeGroup.add(handle);

            safeGroup.position.set(2.8, 1.5, 1.5);
            safeGroup.rotation.y = -Math.PI / 2;
            scene.add(safeGroup);
        }

        function createWardrobe() {
            const wardrobeGroup = new THREE.Group();

            // è¡£æŸœä¸»ä½“
            const wardrobe = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 2.5, 0.6),
                new THREE.MeshStandardMaterial({ color: 0x5c4033, roughness: 0.7 })
            );
            wardrobe.position.y = 1.25;
            wardrobe.castShadow = true;
            wardrobeGroup.add(wardrobe);

            // é—¨ç¼çº¿æ¡
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x3a2819 });
            const edges = new THREE.EdgesGeometry(new THREE.BoxGeometry(1.5, 2.5, 0.6));
            const lines = new THREE.LineSegments(edges, lineMaterial);
            lines.position.y = 1.25;
            wardrobeGroup.add(lines);

            // é—¨æŠŠæ‰‹
            const handle = new THREE.Mesh(
                new THREE.CylinderGeometry(0.03, 0.03, 0.15),
                new THREE.MeshStandardMaterial({ color: 0xc4a747, metalness: 0.8 })
            );
            handle.rotation.z = Math.PI / 2;
            handle.position.set(0.6, 1.25, 0.35);
            wardrobeGroup.add(handle);

            wardrobeGroup.position.set(-2.7, 0, -2.7);
            scene.add(wardrobeGroup);
        }

        function createPlant() {
            const plantGroup = new THREE.Group();

            // èŠ±ç›†
            const pot = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.15, 0.3, 16),
                new THREE.MeshStandardMaterial({ color: 0x8b4513, roughness: 0.8 })
            );
            pot.position.y = 0.15;
            pot.castShadow = true;
            pot.name = 'plant';
            plantGroup.add(pot);
            interactiveObjects.push(pot);

            // åœŸå£¤
            const soil = new THREE.Mesh(
                new THREE.CylinderGeometry(0.18, 0.18, 0.02, 16),
                new THREE.MeshStandardMaterial({ color: 0x3d2914, roughness: 1 })
            );
            soil.position.y = 0.29;
            soil.name = 'plant';
            plantGroup.add(soil);
            interactiveObjects.push(soil);

            // èŒ
            const stemMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22 });
            for (let i = 0; i < 5; i++) {
                const stem = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.01, 0.01, 0.3, 8),
                    stemMaterial
                );
                const angle = (i / 5) * Math.PI * 2;
                stem.position.set(
                    Math.cos(angle) * 0.08,
                    0.5,
                    Math.sin(angle) * 0.08
                );
                stem.rotation.x = Math.random() * 0.3 - 0.15;
                stem.rotation.z = Math.random() * 0.3 - 0.15;
                stem.name = 'plant';
                plantGroup.add(stem);
                interactiveObjects.push(stem);

                // å¶å­
                const leaf = new THREE.Mesh(
                    new THREE.SphereGeometry(0.08, 8, 8),
                    new THREE.MeshStandardMaterial({ color: 0x32cd32, roughness: 0.8 })
                );
                leaf.position.set(
                    Math.cos(angle) * 0.08 + Math.cos(angle) * 0.2,
                    0.7,
                    Math.sin(angle) * 0.08 + Math.sin(angle) * 0.2
                );
                leaf.scale.y = 0.5;
                leaf.name = 'plant';
                plantGroup.add(leaf);
                interactiveObjects.push(leaf);
            }

            // é’¥åŒ™ï¼ˆåœ¨åœŸå£¤é‡Œï¼‰
            const key = new THREE.Mesh(
                new THREE.BoxGeometry(0.05, 0.02, 0.08),
                new THREE.MeshStandardMaterial({ color: 0xc4a747, metalness: 0.9 })
            );
            key.position.set(0.05, 0.31, 0);
            key.rotation.y = Math.PI / 4;
            key.name = 'key';
            key.visible = false;
            plantGroup.add(key);
            interactiveObjects.push(key);

            plantGroup.position.set(2.3, 0, 2.3);
            scene.add(plantGroup);
        }

        function createClock() {
            const clockGroup = new THREE.Group();

            // æ—¶é’Ÿå¤–å£³
            const clockCase = new THREE.Mesh(
                new THREE.CylinderGeometry(0.25, 0.25, 0.05, 32),
                new THREE.MeshStandardMaterial({ color: 0x4a3728, roughness: 0.6 })
            );
            clockCase.rotation.x = Math.PI / 2;
            clockGroup.add(clockCase);

            // æ—¶é’Ÿè¡¨é¢
            const clockFace = new THREE.Mesh(
                new THREE.CircleGeometry(0.22, 32),
                new THREE.MeshStandardMaterial({ color: 0xfffff0 })
            );
            clockFace.position.z = 0.03;
            clockGroup.add(clockFace);

            // æ—¶é’ˆ
            const hourHand = new THREE.Mesh(
                new THREE.BoxGeometry(0.02, 0.12, 0.01),
                new THREE.MeshStandardMaterial({ color: 0x000000 })
            );
            hourHand.position.z = 0.04;
            hourHand.position.y = 0.05;
            hourHand.name = 'clock';
            clockGroup.add(hourHand);
            interactiveObjects.push(hourHand);

            // åˆ†é’ˆ
            const minuteHand = new THREE.Mesh(
                new THREE.BoxGeometry(0.015, 0.16, 0.01),
                new THREE.MeshStandardMaterial({ color: 0x000000 })
            );
            minuteHand.position.z = 0.04;
            minuteHand.position.y = 0.06;
            minuteHand.rotation.z = -Math.PI / 3;
            clockGroup.add(minuteHand);

            // ä¸­å¿ƒç‚¹
            const centerPin = new THREE.Mesh(
                new THREE.CylinderGeometry(0.02, 0.02, 0.02, 16),
                new THREE.MeshStandardMaterial({ color: 0xc4a747, metalness: 0.8 })
            );
            centerPin.rotation.x = Math.PI / 2;
            centerPin.position.z = 0.04;
            clockGroup.add(centerPin);

            clockGroup.position.set(-1.2, 2.8, -2.95);
            clockGroup.rotation.y = 0;
            scene.add(clockGroup);
        }

        function createTrash() {
            const trashGroup = new THREE.Group();

            // æ¡¶èº«
            const trashBody = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.12, 0.35, 16),
                new THREE.MeshStandardMaterial({ color: 0x666666, roughness: 0.5, metalness: 0.3 })
            );
            trashBody.position.y = 0.175;
            trashBody.castShadow = true;
            trashBody.name = 'trash';
            trashGroup.add(trashBody);
            interactiveObjects.push(trashBody);

            // çº¸å›¢
            const paper = new THREE.Mesh(
                new THREE.SphereGeometry(0.06, 8, 8),
                new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.9 })
            );
            paper.position.set(0.05, 0.35, 0.03);
            paper.scale.set(1, 0.8, 0.7);
            paper.name = 'paper';
            trashGroup.add(paper);
            interactiveObjects.push(paper);

            trashGroup.position.set(1.5, 0, -1.5);
            scene.add(trashGroup);
        }

        function createPainting() {
            const paintingGroup = new THREE.Group();

            // ç”»æ¡†
            const frame = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 0.6, 0.05),
                new THREE.MeshStandardMaterial({ color: 0x8b7355, roughness: 0.6 })
            );
            frame.castShadow = true;
            paintingGroup.add(frame);

            // ç”»å¸ƒ
            const canvas = new THREE.Mesh(
                new THREE.PlaneGeometry(0.7, 0.5),
                new THREE.MeshStandardMaterial({ color: 0xffa07a })
            );
            canvas.position.z = 0.03;
            paintingGroup.add(canvas);

            // é£æ™¯ç”»ï¼ˆç®€åŒ–ï¼‰
            const sky = new THREE.Mesh(
                new THREE.PlaneGeometry(0.65, 0.3),
                new THREE.MeshBasicMaterial({ color: 0xffcc99 })
            );
            sky.position.set(0, 0.1, 0.04);
            paintingGroup.add(sky);

            const mountain = new THREE.Mesh(
                new THREE.PlaneGeometry(0.6, 0.2),
                new THREE.MeshBasicMaterial({ color: 0x8b4513 })
            );
            mountain.position.set(0, -0.05, 0.041);
            paintingGroup.add(mountain);

            const sun = new THREE.Mesh(
                new THREE.CircleGeometry(0.08, 16),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            );
            sun.position.set(0.2, 0.15, 0.041);
            paintingGroup.add(sun);

            paintingGroup.position.set(-2.9, 2.2, 1);
            paintingGroup.rotation.y = Math.PI / 2;
            paintingGroup.name = 'painting';
            scene.add(paintingGroup);
            interactiveObjects.push(paintingGroup);
        }

        // ==================== æ·»åŠ äº¤äº’å¯¹è±¡ ====================
        function addInteractiveObjects() {
            // æ‰€æœ‰å¯äº¤äº’å¯¹è±¡å·²æ·»åŠ åˆ°interactiveObjectsæ•°ç»„
        }

        // ==================== äº‹ä»¶å¤„ç† ====================
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // å°„çº¿æ£€æµ‹æ‚¬åœæ•ˆæœ
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactiveObjects);

            if (intersects.length > 0) {
                document.body.style.cursor = 'pointer';
                const hint = document.getElementById('actionHint');
                const objectName = intersects[0].object.name;
                if (objectName && itemData[objectName]) {
                    hint.textContent = `ç‚¹å‡»æŸ¥çœ‹: ${itemData[objectName].name}`;
                    hint.classList.add('visible');
                }
            } else {
                document.body.style.cursor = 'default';
                document.getElementById('actionHint').classList.remove('visible');
            }
        }

        function onMouseClick(event) {
            if (isGameComplete) return;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactiveObjects);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                const objectName = object.name;

                // å¤„ç†ç‰¹æ®Šç‰©å“çš„äº¤äº’é€»è¾‘
                if (objectName === 'plant') {
                    // ç‚¹å‡»ç›†æ ½ï¼Œè·å¾—å°é’¥åŒ™
                    const plantData = itemData['plant'];
                    if (!plantData.collected) {
                        plantData.collected = true;
                        // æ·»åŠ é’¥åŒ™åˆ°èƒŒåŒ…
                        const keyItem = itemData['key'];
                        if (keyItem) {
                            keyItem.collected = true;
                            collectedItems.push('key');
                            showModal('ğŸ”‘ å‘ç°é’¥åŒ™ï¼', 
                                'ä½ åœ¨èŠ±ç›†çš„åœŸå£¤é‡Œå‘ç°äº†ä¸€æŠŠé“¶è‰²çš„å°é’¥åŒ™ï¼è¿™æŠŠé’¥åŒ™çœ‹èµ·æ¥å¯ä»¥æ‰“å¼€ä»€ä¹ˆä¸œè¥¿...', 
                                'å»ä¹¦æ¡ŒæŠ½å±‰è¯•è¯•çœ‹ï¼Ÿ');
                            updateInventory();
                        }
                    } else {
                        showModal(plantData.name, plantData.description, 'ç›†æ ½é‡Œå·²ç»æ²¡æœ‰ä»€ä¹ˆä¸œè¥¿äº†ã€‚');
                    }
                    return;
                }

                // å¤„ç†æŠ½å±‰çš„äº¤äº’é€»è¾‘
                if (objectName === 'drawer') {
                    const drawerData = itemData['drawer'];
                    if (drawerData.opened) {
                        showModal(drawerData.name, 'æŠ½å±‰å·²ç»æ‰“å¼€äº†ï¼Œé‡Œé¢ç©ºç©ºå¦‚ä¹Ÿã€‚', '');
                    } else if (collectedItems.includes('key')) {
                        drawerData.opened = true;
                        showModal('ğŸ”“ æŠ½å±‰å·²æ‰“å¼€ï¼', 
                            `ä½ ç”¨å°é’¥åŒ™æ‰“å¼€äº†æŠ½å±‰ï¼åœ¨æŠ½å±‰é‡Œå‘ç°äº†ä¸€å¼ çº¸æ¡ï¼Œä¸Šé¢å†™ç€ä¸€ä¸²æ•°å­—ï¼š<strong>${safePassword.slice(0,1)}-${safePassword.slice(1,2)}-${safePassword.slice(2,3)}-${safePassword.slice(3,4)}</strong>`,
                            'è¿™çœ‹èµ·æ¥åƒæ˜¯ä¿é™©ç®±çš„å¯†ç ï¼');
                    } else {
                        showModal(drawerData.name, drawerData.description, 'ä½ éœ€è¦æ‰¾åˆ°é’¥åŒ™æ‰èƒ½æ‰“å¼€å®ƒã€‚');
                    }
                    return;
                }

                // å¤„ç†ä¿é™©ç®±çš„äº¤äº’é€»è¾‘
                if (objectName === 'safe') {
                    showPasswordModal('safe', safePassword, 'ğŸ”’ ä¿é™©ç®±å¯†ç ');
                    return;
                }

                // å¤„ç†é—¨çš„äº¤äº’é€»è¾‘
                if (objectName === 'door') {
                    if (collectedItems.includes('safe_content')) {
                        showPasswordModal('door', doorPassword, 'ğŸšª é—¨é”å¯†ç ');
                    } else {
                        showModal(itemData['door'].name, itemData['door'].description, 'ä½ éœ€è¦æ‰¾åˆ°æ‰“å¼€è¿™æ‰‡é—¨çš„æ–¹æ³•...');
                    }
                    return;
                }

                if (objectName && itemData[objectName]) {
                    const item = itemData[objectName];

                    // å¯¹äºæ™®é€šç‰©å“ï¼ˆéç›†æ ½ç­‰ç‰¹æ®Šç‰©å“ï¼‰
                    if (objectName !== 'plant') {
                        showModal(item.name, item.description, item.hint);

                        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¶é›†
                        if (item.canCollect && !item.collected) {
                            collectItem(objectName);
                        }
                    }
                }
            }
        }

        // ==================== ç‰©å“æ”¶é›† ====================
        function collectItem(itemName) {
            const item = itemData[itemName];
            if (!item || item.collected) return;

            item.collected = true;
            collectedItems.push(itemName);

            // éšè—ç‰©å“
            const obj = interactiveObjects.find(obj => obj.name === itemName);
            if (obj) {
                obj.visible = false;
            }

            // æ›´æ–°ç‰©å“æ 
            updateInventory();

            // æ˜¾ç¤ºæ”¶é›†æç¤º
            showHint(`è·å¾—ç‰©å“: ${item.name}`);
        }

        function updateInventory() {
            const content = document.getElementById('inventoryContent');
            
            if (collectedItems.length === 0) {
                content.innerHTML = `
                    <div class="inventory-empty">
                        è¿˜æ²¡æœ‰æ”¶é›†ä»»ä½•ç‰©å“<br>
                        æ¢ç´¢æˆ¿é—´æ¥å‘ç°çº¿ç´¢å§ï¼
                    </div>
                `;
                return;
            }

            content.innerHTML = collectedItems.map(itemName => {
                const item = itemData[itemName];
                return `
                    <div class="inventory-item" onclick="showItemDetail('${itemName}')">
                        <div class="inventory-item-icon">${getItemIcon(itemName)}</div>
                        <div class="inventory-item-name">${item.name}</div>
                        <div class="inventory-item-desc">${item.description.substring(0, 50)}...</div>
                    </div>
                `;
            }).join('');
        }

        function getItemIcon(itemName) {
            const icons = {
                'paper': 'ğŸ“„',
                'diary': 'ğŸ“”',
                'key': 'ğŸ”‘',
                'safe_content': 'ğŸ”‘'
            };
            return icons[itemName] || 'ğŸ“¦';
        }

        // æ˜¾ç¤ºç‰©å“è¯¦æƒ…
        window.showItemDetail = function(itemName) {
            const item = itemData[itemName];
            if (item) {
                showModal(item.name, item.description, item.hint);
            }
        };

        // ==================== UIåŠŸèƒ½ ====================
        function showModal(title, description, hint) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = `
                <p>${description}</p>
                <div class="modal-hint">ğŸ’¡ ${hint}</div>
            `;
            document.getElementById('itemModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
        }

        let currentPassword = '';
        let currentSafeType = '';

        function showPasswordModal(safeType, correctPassword, title) {
            currentPassword = '';
            currentSafeType = safeType;
            updatePasswordDisplay();
            document.getElementById('passwordTitle').textContent = title;
            document.getElementById('passwordHint').textContent = `è¯·è¾“å…¥${correctPassword.length}ä½å¯†ç `;
            document.getElementById('passwordModal').classList.add('active');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            currentPassword = '';
            currentSafeType = '';
        }

        function updatePasswordDisplay() {
            const display = document.getElementById('passwordDisplay');
            const dots = currentPassword.padEnd(4, '-');
            display.textContent = dots.split('').join(' ');
        }

        function handlePasswordDigit(digit) {
            if (digit === 'clear') {
                currentPassword = '';
            } else if (digit === 'enter') {
                checkPassword();
                return;
            } else {
                if (currentPassword.length < 4) {
                    currentPassword += digit;
                }
            }
            updatePasswordDisplay();
        }

        function checkPassword() {
            const safeData = itemData[currentSafeType];
            
            if (currentSafeType === 'safe' && currentPassword === safePassword) {
                if (safeData.opened) {
                    closePasswordModal();
                    showModal(safeData.name, 'ä¿é™©ç®±å·²ç»æ‰“å¼€äº†ï¼Œé‡Œé¢ç©ºç©ºå¦‚ä¹Ÿã€‚', '');
                } else {
                    safeData.opened = true;
                    closePasswordModal();
                    collectItem('safe_content');
                    showModal('ğŸ”“ ä¿é™©ç®±å·²æ‰“å¼€ï¼', 
                        `ä½ æˆåŠŸæ‰“å¼€äº†ä¿é™©ç®±ï¼åœ¨é‡Œé¢çš„çº¸æ¡ä¸Šå†™ç€ä¸€ä¸²æ•°å­—ï¼š<strong>${doorPassword.slice(0,1)}-${doorPassword.slice(1,2)}-${doorPassword.slice(2,3)}-${doorPassword.slice(3,4)}</strong>ï¼Œè¿˜æœ‰ä¸€æŠŠé‡‘è‰²çš„é’¥åŒ™ï¼`,
                        'è¿™ä¸€å®šæ˜¯å¼€é—¨ç”¨çš„å¯†ç å’Œé’¥åŒ™ï¼');
                }
            } else if (currentSafeType === 'door' && currentPassword === doorPassword) {
                if (collectedItems.includes('safe_content')) {
                    closePasswordModal();
                    gameComplete();
                } else {
                    closePasswordModal();
                    showModal(itemData['door'].name, 'å¯†ç æ­£ç¡®ï¼Œä½†ä½ æ²¡æœ‰é’¥åŒ™...', 'ä½ éœ€è¦æ‰¾åˆ°é’¥åŒ™æ‰èƒ½æ‰“å¼€è¿™æ‰‡é—¨ã€‚');
                }
            } else {
                document.getElementById('passwordDisplay').textContent = 'ERR';
                document.getElementById('passwordDisplay').style.color = '#ff6464';
                document.getElementById('passwordDisplay').style.borderColor = '#ff6464';
                setTimeout(() => {
                    currentPassword = '';
                    document.getElementById('passwordDisplay').style.color = '#00ff88';
                    document.getElementById('passwordDisplay').style.borderColor = '#00ff88';
                    updatePasswordDisplay();
                }, 800);
            }
        }

        function gameComplete() {
            isGameComplete = true;
            document.getElementById('successOverlay').classList.add('active');
            showHint('ğŸ‰ æ­å–œä½ æˆåŠŸé€ƒè„±ï¼');
        }

        function toggleInventory() {
            document.getElementById('inventoryPanel').classList.toggle('active');
        }

        function resetView() {
            camera.position.set(4, 3, 5);
            controls.target.set(0, 1.5, 0);
            controls.update();
        }

        function showHint(text) {
            const hint = document.getElementById('actionHint');
            hint.textContent = text;
            hint.classList.add('visible');
            setTimeout(() => {
                hint.classList.remove('visible');
            }, 2000);
        }

        function restartGame() {
            // é‡æ–°ç”Ÿæˆéšæœºå¯†ç 
            initRandomPasswords();
            itemData['safe'].hint = `è¾“å…¥å¯†ç  ${safePassword.slice(0,1)}-${safePassword.slice(1,2)}-${safePassword.slice(2,3)}-${safePassword.slice(3,4)} è¯•è¯•çœ‹ï¼`;

            // é‡ç½®æ‰€æœ‰æ”¶é›†çŠ¶æ€
            Object.keys(itemData).forEach(key => {
                if (itemData[key].collected) {
                    itemData[key].collected = false;
                }
                if (itemData[key].opened) {
                    itemData[key].opened = false;
                }
            });
            collectedItems = [];
            isGameComplete = false;

            // é‡æ–°æ˜¾ç¤ºæ‰€æœ‰ç‰©å“
            interactiveObjects.forEach(obj => {
                if (obj.name && itemData[obj.name] && itemData[obj.name].canCollect) {
                    obj.visible = true;
                }
            });

            // æ›´æ–°UI
            updateInventory();
            document.getElementById('successOverlay').classList.remove('active');

            showHint('æ¸¸æˆé‡æ–°å¼€å§‹ï¼æ¢ç´¢æˆ¿é—´å¯»æ‰¾çº¿ç´¢å§ã€‚');
        }

        // ==================== åŠ¨ç”»å¾ªç¯ ====================
        let frameCount = 0;
        let lastTime = performance.now();

        function animate() {
            requestAnimationFrame(animate);

            // FPSè®¡ç®—
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= 1000) {
                document.getElementById('fpsValue').textContent = frameCount;
                frameCount = 0;
                lastTime = currentTime;
            }

            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();

            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
        }

        // ==================== å¯åŠ¨ ====================
        init();
    </script>
</body>
</html>
